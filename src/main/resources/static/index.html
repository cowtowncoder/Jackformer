<!doctype html>
<html lang="en">
  <head><title>Jackformer!</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
<link rel='stylesheet' type='text/css' href='css/style_2021_02_08.css'>
<script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type='text/javascript'>
  var currentInputFormat = "";
  var currentOutputFormat = "";
  var currentInputMode = "";
  var currentInputFile = "";
  var currentInputText = 0; // 0/1 for empty/non-empty
  var binaryInput = false;
  var binaryOutput = false;

function updateUIState() {
  if (currentInputFormat) { // got valid input format choice
    showRow("input-format");
    if (currentOutputFormat) { // got valid output format choice
      showRow("output-format");
      var result = updateUIStateByInputMode();
      if (result) { // got input content select!
        activateRow("action");
      } else { // no input mode
        hideRow("action");
      }
    } else {
      activateRow("output-format");
      hideRow("input-mode");
      hideRow("input-as-file");
      hideRow("input-as-text");
      hideRow("action-row");
    }
  } else { // no valid choice
      activateRow("input-format");
      hideRow("output-format");
      hideRow("input-mode");
      hideRow("input-as-file");
      hideRow("input-as-text");
      hideRow("action");
  }
}

function updateUIStateByInputMode() {
  if (currentInputMode == "input-mode-file") {
    showRow("input-mode");
    activateRow("input-as-file");
    hideRow("input-as-text");
    return currentInputFile;
  }
  if (currentInputMode == "input-mode-text") {
    showRow("input-mode");
    hideRow("input-as-file");
    activateRow("input-as-text");
    return currentInputText;
  }
  // No valid selection
  activateRow("input-mode");
  hideRow("input-as-file");
  hideRow("input-as-text");
  return false;
}

function isBinary(formatId) {
  return formatId == "smile" || formatId == "cbor";
}
function hideRow(rowId) {
  $("#"+rowId+"-row").removeClass("shown active").addClass("hidden");
}
function showRow(rowId) {
  $("#"+rowId+"-row").removeClass("hidden active").addClass("shown");
}
function activateRow(idBase) {
  // activate row via class; put focus on selector
  $("#"+idBase+"-row").removeClass("hidden shown").addClass("active");
  $("#"+idBase).focus();
}

function actionTransformAndShow() {
  // First: which mode is user expecting? Submission methods vary a lot
  if (currentInputMode == "input-mode-file") {
    actionTransformAndShowFile();
  } else if (currentInputMode == "input-mode-text") {
    actionTransformAndShowText();
  } else {
    alert("Jackformer is confused: unrecognized current input mode of: "+currentInputMode);
  }
}

function actionTransformAndShowFile() {
  // clean output first:
  $("#output-content").val("");
  // then try to submit
  var form = $("#form-input");
  var formData = new FormData(form[0]);

  $.ajax({
        url: "rest/jackform-with-form",
        type: "POST",
        cache: false,
        // Sending content as form data
        data: formData,
// Not sure why but as per:
// https://stackoverflow.com/questions/25390598/append-called-on-an-object-that-does-not-implement-interface-formdata
// need following 2 options
        processData: false,
        contentType: false, // NOT "multipart/form-data"

        // Response is json
        dataType : "json",
        success: handleTransformResponseOk,
        error: handleTransformResponseFail,
//        contentType: false,
//        processData: false
  });
}

function actionTransformAndShowText() {
  var inputFormat = $("#input-format").val();
  var outputFormat = $("#output-format").val();
  var inputContent = $("#input-as-text").val();
  var url = "rest/jackform?inputFormat="+inputFormat+"&outputFormat="+outputFormat;

  // clean output first:
  $("#output-content").val("");
  $("#output-status-message").text("Sending...");
  // $.getJSON is a fail, alas, wrt Content-Type missing etc so
  var result = $.ajax({
  	url : url,
  	type: "POST",
     cache: false,
  	// Sending json/xml/csv whatever; not to be processed, as payload;
  	contentType: "application/octet-stream",
  	data: inputContent,
     processData: false,
     // Response is json, however
  	dataType : "json",
  	success: handleTransformResponseOk,
  	error: handleTransformResponseFail
  });
}

function handleTransformResponseOk(resp) {
  // OK only means that call succeeded; not necessarily that the
  // transformation did...
  if (resp.ok) {
    $("#output-status-message").text("OK");
    $("#output-content").val(resp.transformed);
    showRow("output-content");
  } else {
    $("#output-status-message").text("FAIL, type: "+resp.errorType+", message: "+resp.errorMessage);
    hideRow("output-content");
  }  
}

function handleTransformResponseFail(hdr, textStatus, errorString) {
  $("#output-status-message").text("FAIL! Reason: "+textStatus);
  hideRow("output-content");
//  alert("Got FAIL response, status: "+textStatus+", error: "+errorString);
}

</script>
  </head>
  <body>
    <h1>Jackformer - the Transformative Tool</h1>
<table><tr><td>
<form id="form-input" method="post" enctype="multipart/form-data">
  <table class="inputTable">
  <tr id="input-format-row" class="active">
<td class="label"><span class="prompt">* </span><label for="input-format">Input Format: </label></td>
<td class="selector"><select id="input-format" name="inputFormat" size="1">
   <option value=""></option>
   <option value="cbor">CBOR</option>
   <option value="json">JSON</option>
   <option value="properties">Properties</option>
   <option value="smile">Smile</option>
   <option value="xml">XML</option>
   <option value="yaml">YAML</option>
</select></td>
   </tr>
  <tr id="output-format-row" class="hidden">
<td class="label"><span class="prompt">* </span><label for="output-format">Output Format: </label></td>
<td class="selector"><select id="output-format" name="outputFormat">
   <option value=""></option>
   <option value="cbor">CBOR</option>
   <option value="json">JSON</option>
   <option value="json-pretty">JSON (pretty)</option>
   <option value="properties">Properties</option>
   <option value="smile">Smile</option>
   <option value="xml">XML</option>
   <option value="xml-pretty">XML (pretty)</option>
   <option value="yaml">YAML</option>
</select></td>
   </tr>
  <tr id="input-mode-row" class="hidden">
<td class="label"><span class="prompt">* </span>Input Source: </td>
<td class="selector"><select id="input-mode">
   <option value=""></option>
   <option value="input-mode-text">Text</option>
   <option value="input-mode-file">Upload</option>
</select></td>
   </tr>
  <tr id="input-as-file-row" class="hidden collapsed">
<td class="label"><span class="prompt">* </span>Input File: </td>
<td class="selector"><input type="file" id="input-as-file" name="inputContent"></input>
   </tr>
  <tr id="input-as-text-row" class="infoRow hidden collapsed">
<td class="label"><span class="prompt">* </span>Input Content: </td>
<td class="selector"><textarea id="input-as-text" rows="12" cols="80"></textarea>
   </tr>
  <tr id="action-row" class="hidden">
<td class="label"> </td>
<td class="selector">
<button type="button" class="button" id="button-show">Transform and Show</button>
<button type="button" class="button" id="button-download">Transform and Download</button>
    </td>
   </tr>
  </table>
</form>
</td></tr></table>

<p>
<div height="50">
</div>
</p>

<form id="outputForm">
 <table class="outputTable">
  <tr id="output-status-row" class="shown">
<td class="label">Status: </td>
<td><span id="output-status-message"> </span></td>
  </tr>
  <tr id="output-content-row" class="hidden collapsed">
<td class="label">Transformed Content: </td>
<td><textarea id="output-content" class="outputText" rows="12" cols="80"></textarea></td>
  </tr>
</table>  

<script>

// First: listeners for input control changes
$("#input-format").on("change", function() {
  var inputFormat = $(this).val();
  if (currentInputFormat != inputFormat) {
    currentInputFormat = inputFormat;
    // Otherwise simple but need to disable text-input for binary input
    binaryInput = isBinary(inputFormat);
    if (binaryInput) {
      $("#input-mode").val("input-mode-file").prop("disabled", true);
      // will not fire event so update directly:
      currentInputMode = "input-mode-file";
    } else {
      $("#input-mode").prop("disabled", false);
    }
    updateUIState();
  }
});
$("#output-format").on("change", function() {
  var outputFormat = $(this).val();
  if (currentOutputFormat != outputFormat) {
    currentOutputFormat = outputFormat;
    // Otherwise simple but need to disable "transform & show" option
    binaryOutput = isBinary(outputFormat);
    if (binaryOutput) {
      $("#button-show").addClass("hidden");
    } else {
      $("#button-show").removeClass("hidden");
    }
    updateUIState();
  }
});
$("#input-mode").on("change", function() {
  var inputMode = $(this).val();
  if (currentInputMode != inputMode) {
    currentInputMode = inputMode;
    updateUIState();
  }
});
$("#input-as-file").on("change", function() {
  var inputFile = $(this).val();
  if (currentInputFile != inputFile) {
    currentInputFile = inputFile;
    updateUIState();
  }
});
// Textareas are tricky. 'Change' only triggers on losing focus so need
// to also do "keyup" it seems
var inputAsText = $("#input-as-text");
var inputAsTextFunc = function() {
  var inputStr = $(this).val();
  var inputText = Math.min(inputStr.length, 1);
  if (currentInputText != inputText) {
    currentInputText = inputText;
    updateUIState();
  }
};
inputAsText.on("change", inputAsTextFunc);
inputAsText.on("keyup", inputAsTextFunc);

// Second: invoking transformations
$("#button-show").click(actionTransformAndShow);
$("#button-download").click(function(evt) {
//  actionTransformAndDownload();
  // Not yet implemented
});

// !!! TODO? Do we need to initialize Javascript value fields (saw an
//  odd error)
// Finally, activate the input format selector directly:
$("#input-format").focus();
</script>

  </body>
</html>
